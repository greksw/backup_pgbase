–®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

TIME=`date +"%Y-%m-%d_%H-%M"`
LOG_FILE="/mnt/pgsql.log"
MOUNT_POINT1="/mnt/backup/PgSql/pgsql"
# Telegram Bot API –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
TOKEN="22222222:111111111eejccLggbvO22222222"
CHAT_ID="111111111"
SCRIPT_NAME="–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ 1c8c_PG_everyday:\Rabota"

TIME: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π.
LOG_FILE: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –∂—É—Ä–Ω–∞–ª–∞, –∫—É–¥–∞ –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤—Å–µ —Å–æ–±—ã—Ç–∏—è —Å–∫—Ä–∏–ø—Ç–∞.
MOUNT_POINT1: –¢–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–µ—Ç–µ–≤–æ–π —à–∞—Ä—ã, –∫—É–¥–∞ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏.
TOKEN –∏ CHAT_ID: –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ ID —á–∞—Ç–∞ –≤ Telegram, –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
SCRIPT_NAME: –ò–º—è —Å–∫—Ä–∏–ø—Ç–∞, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –≤–∫–ª—é—á–µ–Ω–æ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞.

–®–∞–≥ 2: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

log_and_notify() {
    local message="$1"
    echo "$(date '+%Y-%m-%d %H:%M:%S') $message" >> $LOG_FILE
    curl -s -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" -d chat_id=$CHAT_ID -d text="$SCRIPT_NAME: $message" > /dev/null
}

log_and_notify: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–∞.
–ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –≤ –ª–æ–≥-—Ñ–∞–π–ª.
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram —á–µ—Ä–µ–∑ API.

–®–∞–≥ 3: –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

backup_and_notify() {
    local dbname="$1"
    local output_path="$2"
    pg_dump -U postgres $dbname | pigz > $output_path
    if [ $? -eq 0 ]; then
        log_and_notify "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö $dbname —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞."
    else
        log_and_notify "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö $dbname."
    fi
}

backup_and_notify: –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è:
–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (dbname) –∏ –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (output_path).
–í—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é pg_dump –∏ —Å–∂–∏–º–∞–µ—Ç —Ñ–∞–π–ª —Å –ø–æ–º–æ—â—å—é pigz.
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã ($?), –∏ –µ—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞. –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.

–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–∞

HOST1="192.168.1.2"
ping -c 1 $HOST1 > /dev/null 2>&1
HOST1_STATUS=$?

HOST1: IP-–∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.
ping: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ ping, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Ö–æ—Å—Ç.
–ï—Å–ª–∏ —Ö–æ—Å—Ç –æ—Ç–≤–µ—á–∞–µ—Ç, –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è HOST1_STATUS –±—É–¥–µ—Ç —Ä–∞–≤–Ω–∞ 0 (—É—Å–ø–µ—à–Ω–æ).
–ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ HOST1_STATUS –±—É–¥–µ—Ç –æ—Ç–ª–∏—á–Ω–∞ –æ—Ç 0 (–Ω–µ—É–¥–∞—á–Ω–æ).

–®–∞–≥ 5: –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–∞

if [ $HOST1_STATUS -eq 0 ]; then
    log_and_notify "‚úÖ –•–æ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω, –º–æ–Ω—Ç–∏—Ä—É–µ–º —à–∞—Ä—ã..."
    sudo mount -t cifs //192.168.1.2/d$/Rabota $MOUNT_POINT1 -o username=usr1,password=123,domain=workgroup,iocharset=utf8,file_mode=0777,dir_mode=0777
    MOUNT1_STATUS=$?

–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–∞: –ï—Å–ª–∏ —Ö–æ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω ($HOST1_STATUS -eq 0):
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, —á—Ç–æ —Ö–æ—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.
–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–π —à–∞—Ä—ã.
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ($MOUNT1_STATUS).

–®–∞–≥ 6: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

if [ $MOUNT1_STATUS -eq 0 ]; then
    log_and_notify "‚úÖ –®–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º pgbackup script..."
    
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞ –¥–ª—è –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
    backup_and_notify "bueks" "/mnt/backup/PgSql/everyday/bueks/$TIME-bueks.sql.gz"
    # (–¥—Ä—É–≥–∏–µ –≤—ã–∑–æ–≤—ã backup_and_notify –¥–ª—è –∫–∞–∂–¥–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö)
    
    echo "`date +'%Y-%m-%d_%H-%M-%S'` End backup" >> /mnt/backup/PgSql/pgsql-everyday-backup.log
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
    find /mnt/backup/PgSql/everyday -type f -mtime +60 -exec rm -rf {} \;

    log_and_notify "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
    sudo umount $MOUNT_POINT1
    log_and_notify "‚úÖ –®–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞."
else
    log_and_notify "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞—Ä—É."
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Å–ª—É—á–∞–µ —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if mount | grep $MOUNT_POINT1 > /dev/null; then
        sudo umount $MOUNT_POINT1
    fi
fi

–£—Å–ø–µ—à–Ω–æ–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ï—Å–ª–∏ —à–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ ($MOUNT1_STATUS -eq 0):
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.
–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é –≤—ã–∑–æ–≤–∞ backup_and_notify.
–í –∫–æ–Ω—Ü–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –±—ç–∫–∞–ø–∞ –≤ –ª–æ–≥-—Ñ–∞–π–ª.
–£–¥–∞–ª—è—é—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏, –∫–æ—Ç–æ—Ä—ã–º –±–æ–ª—å—à–µ 60 –¥–Ω–µ–π.
–®–∞—Ä–∞ –æ—Ç–º–æ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è, –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —ç—Ç–æ–º.
–ù–µ—É–¥–∞—á–Ω–æ–µ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ï—Å–ª–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ—É–¥–∞—á–µ.
–ï—Å–ª–∏ —à–∞—Ä–∞ –±—ã–ª–∞ —á–∞—Å—Ç–∏—á–Ω–æ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ø—ã—Ç–∫–∞ –µ—ë —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

–®–∞–≥ 7: –î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–∞

else
    log_and_notify "‚ùå –•–æ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
fi

–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞: –ï—Å–ª–∏ —Ö–æ—Å—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω ($HOST1_STATUS -ne 0), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–∞.

–ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–°–∫—Ä–∏–ø—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞, –º–æ–Ω—Ç–∏—Ä—É–µ—Ç —Å–µ—Ç–µ–≤—É—é —à–∞—Ä—É, –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è —É—Å–ø–µ—à–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –æ—à–∏–±–∫–∏.
